/**
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

CountryCodesMap = {
'AF': 'Afghanistan',
'AX': 'Ã…land Islands',
'AL': 'Albania',
'DZ': 'Algeria',
'AS': 'American Samoa',
'AD': 'Andorra',
'AO': 'Angola',
'AI': 'Anguilla',
'AQ': 'Antarctica',
'AG': 'Antigua and Barbuda',
'AR': 'Argentina',
'AM': 'Armenia',
'AW': 'Aruba',
'AU': 'Australia',
'AT': 'Austria',
'AZ': 'Azerbaijan',
'BS': 'Bahamas',
'BH': 'Bahrain',
'BD': 'Bangladesh',
'BB': 'Barbados',
'BY': 'Belarus',
'BE': 'Belgium',
'BZ': 'Belize',
'BJ': 'Benin',
'BM': 'Bermuda',
'BT': 'Bhutan',
'BO': 'Bolivia',
'BA': 'Bosnia and Herzegovina',
'BW': 'Botswana',
'BV': 'Bouvet Island',
'BR': 'Brazil',
'IO': 'British Indian Ocean Territory',
'BN': 'Brunei Darussalam',
'BG': 'Bulgaria',
'BF': 'Burkina Faso',
'BI': 'Burundi',
'KH': 'Cambodia',
'CM': 'Cameroon',
'CA': 'Canada',
'CV': 'Cape Verde',
'KY': 'Cayman Islands',
'CF': 'Central African Republic',
'TD': 'Chad',
'CL': 'Chile',
'CN': 'China',
'CX': 'Christmas Island',
'CC': 'Cocos (Keeling) Islands',
'CO': 'Colombia',
'KM': 'Comoros',
'CG': 'Congo',
'CD': 'Congo, The Democratic Republic of The',
'CK': 'Cook Islands',
'CR': 'Costa Rica',
'CI': 'Cote D\'ivoire',
'HR': 'Croatia',
'CU': 'Cuba',
'CY': 'Cyprus',
'CZ': 'Czech Republic',
'DK': 'Denmark',
'DJ': 'Djibouti',
'DM': 'Dominica',
'DO': 'Dominican Republic',
'EC': 'Ecuador',
'EG': 'Egypt',
'SV': 'El Salvador',
'GQ': 'Equatorial Guinea',
'ER': 'Eritrea',
'EE': 'Estonia',
'ET': 'Ethiopia',
'FK': 'Falkland Islands (Malvinas)',
'FO': 'Faroe Islands',
'FJ': 'Fiji',
'FI': 'Finland',
'FR': 'France',
'GF': 'French Guiana',
'PF': 'French Polynesia',
'TF': 'French Southern Territories',
'GA': 'Gabon',
'GM': 'Gambia',
'GE': 'Georgia',
'DE': 'Germany',
'GH': 'Ghana',
'GI': 'Gibraltar',
'GR': 'Greece',
'GL': 'Greenland',
'GD': 'Grenada',
'GP': 'Guadeloupe',
'GU': 'Guam',
'GT': 'Guatemala',
'GG': 'Guernsey',
'GN': 'Guinea',
'GW': 'Guinea-bissau',
'GY': 'Guyana',
'HT': 'Haiti',
'HM': 'Heard Island and Mcdonald Islands',
'VA': 'Holy See (Vatican City State)',
'HN': 'Honduras',
'HK': 'Hong Kong',
'HU': 'Hungary',
'IS': 'Iceland',
'ID': 'Indonesia',
'IR': 'Iran, Islamic Republic of',
'IQ': 'Iraq',
'IE': 'Ireland',
'IM': 'Isle of Man',
'IL': 'Israel',
'IT': 'Italy',
'JM': 'Jamaica',
'JP': 'Japan',
'JE': 'Jersey',
'JO': 'Jordan',
'KZ': 'Kazakhstan',
'KE': 'Kenya',
'KI': 'Kiribati',
'KP': 'Korea, Democratic People\'s Republic of',
'KR': 'Korea, Republic of',
'KW': 'Kuwait',
'KG': 'Kyrgyzstan',
'LA': 'Lao People\'s Democratic Republic',
'LV': 'Latvia',
'LB': 'Lebanon',
'LS': 'Lesotho',
'LR': 'Liberia',
'LY': 'Libyan Arab Jamahiriya',
'LI': 'Liechtenstein',
'LT': 'Lithuania',
'LU': 'Luxembourg',
'MO': 'Macao',
'MK': 'Macedonia, The Former Yugoslav Republic of',
'MG': 'Madagascar',
'MW': 'Malawi',
'MY': 'Malaysia',
'MV': 'Maldives',
'ML': 'Mali',
'MT': 'Malta',
'MH': 'Marshall Islands',
'MQ': 'Martinique',
'MR': 'Mauritania',
'MU': 'Mauritius',
'YT': 'Mayotte',
'MX': 'Mexico',
'FM': 'Micronesia, Federated States of',
'MD': 'Moldova, Republic of',
'MC': 'Monaco',
'MN': 'Mongolia',
'ME': 'Montenegro',
'MS': 'Montserrat',
'MA': 'Morocco',
'MZ': 'Mozambique',
'MM': 'Myanmar',
'NA': 'Namibia',
'NR': 'Nauru',
'NP': 'Nepal',
'NL': 'Netherlands',
'AN': 'Netherlands Antilles',
'NC': 'New Caledonia',
'NZ': 'New Zealand',
'NI': 'Nicaragua',
'NE': 'Niger',
'NG': 'Nigeria',
'NU': 'Niue',
'NF': 'Norfolk Island',
'MP': 'Northern Mariana Islands',
'NO': 'Norway',
'OM': 'Oman',
'PK': 'Pakistan',
'PW': 'Palau',
'PS': 'Palestinian Territory, Occupied',
'PA': 'Panama',
'PG': 'Papua New Guinea',
'PY': 'Paraguay',
'PE': 'Peru',
'PH': 'Philippines',
'PN': 'Pitcairn',
'PL': 'Poland',
'PT': 'Portugal',
'PR': 'Puerto Rico',
'QA': 'Qatar',
'RE': 'Reunion',
'RO': 'Romania',
'RU': 'Russian Federation',
'RW': 'Rwanda',
'SH': 'Saint Helena',
'KN': 'Saint Kitts and Nevis',
'LC': 'Saint Lucia',
'PM': 'Saint Pierre and Miquelon',
'VC': 'Saint Vincent and The Grenadines',
'WS': 'Samoa',
'SM': 'San Marino',
'ST': 'Sao Tome and Principe',
'SA': 'Saudi Arabia',
'SN': 'Senegal',
'RS': 'Serbia',
'SC': 'Seychelles',
'SL': 'Sierra Leone',
'SG': 'Singapore',
'SK': 'Slovakia',
'SI': 'Slovenia',
'SB': 'Solomon Islands',
'SO': 'Somalia',
'ZA': 'South Africa',
'GS': 'South Georgia and The South Sandwich Islands',
'ES': 'Spain',
'LK': 'Sri Lanka',
'SD': 'Sudan',
'SR': 'Suriname',
'SJ': 'Svalbard and Jan Mayen',
'SZ': 'Swaziland',
'SE': 'Sweden',
'CH': 'Switzerland',
'SY': 'Syrian Arab Republic',
'TW': 'Taiwan, Province of China',
'TJ': 'Tajikistan',
'TZ': 'Tanzania, United Republic of',
'TH': 'Thailand',
'TL': 'Timor-leste',
'TG': 'Togo',
'TK': 'Tokelau',
'TO': 'Tonga',
'TT': 'Trinidad and Tobago',
'TN': 'Tunisia',
'TR': 'Turkey',
'TM': 'Turkmenistan',
'TC': 'Turks and Caicos Islands',
'TV': 'Tuvalu',
'UG': 'Uganda',
'UA': 'Ukraine',
'AE': 'United Arab Emirates',
'GB': 'United Kingdom',
'US': 'United States',
'UM': 'United States Minor Outlying Islands',
'UY': 'Uruguay',
'UZ': 'Uzbekistan',
'VU': 'Vanuatu',
'VE': 'Venezuela',
'VN': 'Viet Nam',
'VG': 'Virgin Islands, British',
'VI': 'Virgin Islands, U.S.',
'WF': 'Wallis and Futuna',
'EH': 'Western Sahara',
'YE': 'Yemen',
'ZM': 'Zambia',
'ZW': 'Zimbabwe' };

IndianStatesList = ['Andaman_and_Nicobar_Islands', 'Andhra_Pradesh',
'Arunachal_Pradesh', 'Assam', 'Bihar', 'Chandigarh', 'Chhattisgarh',
'Dadra_and_Nagar_Haveli', 'Delhi', 'Goa', 'Gujarat', 'Haryana',
'Himachal_Pradesh', 'Jammu_and_Kashmir', 'Jharkhand', 'Karnataka', 'Kerala',
'Lakshadweep', 'Madhya_Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya',
'Mizoram', 'Nagaland', 'Odisha', 'Pondicherry', 'Punjab', 'Rajasthan', 'Sikkim',
'Tamil_Nadu', 'Telangana', 'Tripura', 'Uttarakhand', 'Uttar_Pradesh', 'West_Bengal'];

// LocalChapterList should be defined in register.html

function toTitleCase(str)
{
    return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
}

function addOptionElement(id, value, text) {
  var opt = document.createElement('option');
  opt.value = value;
  opt.text = text;
  opt.innerText = text;
  opt.setAttribute('id', id);
  return opt;
}

function fillGraduationYearOptions() {
  select_el = element('graduationyear');
  for (var i = 1950; i < 2024; ++i) {
    select_el.appendChild(addOptionElement('year_' + i, i, i));
  }
}

function fillIndianStateOptions() {
  select_el = element('state_of_residence');
  for (var i = 0; i < IndianStatesList.length; ++i) {
    state = IndianStatesList[i];
    select_el.appendChild(
      addOptionElement('state_' + state, state, state.replace(/_/g, ' ')));
  }
}

function fillCountriesOptions() {
  select_el = element('country_of_residence');
  for (var c in CountryCodesMap) {
     country_name = CountryCodesMap[c];
     select_el.appendChild(addOptionElement('country_' + c, c, country_name));
  }
}

function fillLocalChapterCollegeOptions() {
  localChapterIDs = Object.keys(LocalChapterList);
  localChapterIDs.sort();
  select_el = element('local_chapter_college');
  for (var i in localChapterIDs) {
    var localChapterId = localChapterIDs[i];
    var localChapter = LocalChapterList[localChapterId];
    var localChapterElementId = 'local_chapter_college_' + localChapterId;
    var localChapterVisibleText = [
      localChapter.name,
      localChapter.city,
      localChapter.state
    ].join(', ');
    select_el.appendChild(addOptionElement(
      localChapterElementId, localChapterId, localChapterVisibleText
    ));
  }

  select_el.appendChild(
    addOptionElement('local_chapter_college_other', 'other', 'Other'));

  //Check if value already present from jinja2
  var oldCollegeId = element('old_college_id').value;
  if (oldCollegeId) {
    select_el.value = oldCollegeId;
  }
}

function hideShowLocalChapter(country, profession) {
  var local_chapter_block = element('localChapterLi');
  var local_chapter_college_el = element('local_chapter_college');
  var local_chapter_el = element('local_chapter');
  if (!country) {
    country = getSelectValue(element("country_of_residence"));
  }
  if (!profession) {
    profession = getSelectValue(element("profession"));
  }
  if ("IN" == country && (profession == "student" || profession == "faculty")) {
    local_chapter_block.style.display = '';
    local_chapter_el.required = true;
    local_chapter_college_el.required = true;
  }
  else {
    local_chapter_block.style.display = 'none';
    local_chapter_el.selectedIndex = 0;
    local_chapter_el.required = false;
    local_chapter_college_el.required = false;
  }
  localChapterOnChanged();
}

function getSelectValue(selectEl) {
  return selectEl.options[selectEl.selectedIndex].value;
}

function countryChanged() {
  country = getSelectValue(
      element("country_of_residence"));

  var indian_state_block = element("indianStateLi");
  var non_indian_state_block = element("nonIndianStateLi");
  var local_chapter_college_el = element('local_chapter_college');
  var indian_state_select_el = element('state_of_residence');
  if ("IN" === country) {
    non_indian_state_block.style.display = 'none';
    indian_state_block.style.display = '';
    local_chapter_college_el.style.display = '';
    indian_state_select_el.required = true;

  } else {
    indian_state_block.style.display = 'none';
    non_indian_state_block.style.display = '';
    if (country) {
      local_chapter_college_el.value = 'other';
      localChapterCollegeChanged();
      local_chapter_college_el.style.display = 'none';
      indian_state_select_el.required = false;
    }
  }
  hideShowLocalChapter(country, null);
}

function professionChanged() {
  profession = getSelectValue(element("profession"));
  employer_block = element("employerLi");
  if ("employed" == profession) {
    employer_block.style.display = '';
  } else {
    employer_block.style.display = 'none';
  }
  hideShowLocalChapter(null, profession);
}

function prefillSelect(old_id, select_id, id_prefix) {
  old_value =  element(old_id).value;
  if ('' != old_value) {
    select_opt = element(id_prefix + old_value.replace(RegExp(' ', 'g'), '_')).index;
    element(select_id).selectedIndex = select_opt;
  }
}

function IndianStateOnChanged() {
  var state = getSelectValue(element('state_of_residence'));
  state = state.toUpperCase().trim().replace(RegExp(' ', 'g'), '_');
  $.each($('#local_chapter_college').children(), function(idx, el) {
    if (el.value) {
      if (el.value == 'other') {
        el.style.display = '';
        return;
      }
      var lc_college_id = el.value;
      var lc_college_state = LocalChapterList[lc_college_id].state;
      lc_college_state = lc_college_state.toUpperCase().trim().replace(RegExp(' ', 'g'), '_');
      if (lc_college_state === state || state === 'ALL') {
        el.style.display = '';
      }
      else {
        el.style.display = 'none';
      }
    }
  });
  var current_local_chapter_college_id = getSelectValue(element('local_chapter_college'));
  if (current_local_chapter_college_id && current_local_chapter_college_id !== "other") {
    var current_lc_state = LocalChapterList[current_local_chapter_college_id].state;
    current_lc_state = current_lc_state.toUpperCase().trim().replace(RegExp(' ', 'g'), '_');
    if (current_lc_state != state) {
      element('local_chapter_college').selectedIndex = 0;
    }
  }

}

function localChapterOnChanged() {
  var localChapter = getSelectValue(element('local_chapter'));
  var lcCollege = element('local_chapter_college');
  var lcCollegeOtherOption = element('local_chapter_college_other');
  var country = getSelectValue(element('country_of_residence'));
  var profession = getSelectValue(element('profession'));
  var txtCollege = element('college');
  var cityBlockEl = element('cityLi');
  if (country !== 'IN' || (profession !== 'student' && profession != 'faculty')) {
    localChapter = false;
  }
  if (localChapter === 'true' || localChapter === true) {
    lcCollegeOtherOption.disabled = true;
    txtCollege.value = '';
    txtCollege.style.display = 'none';
    cityBlockEl.value = "";
    cityBlockEl.style.display = 'none';
    if (getSelectValue(lcCollege) == 'other') {
      lcCollege.value = '';
      localChapterCollegeChanged();
    }
  }
  else {
    lcCollegeOtherOption.disabled = false;
  }
}

function localChapterCollegeChanged() {
  var localChapterValue = element('local_chapter_college').value;
  var cityEl = element('city_of_residence');
  var cityBlockEl = element('cityLi');
  var collegeEl = element('college');
  var collegeIdEl = element('college_id');
  if (!localChapterValue) {
    cityEl.value = "";
    collegeEl.value = "";
    collegeIdEl.value = "";
    return;
  }
  if (localChapterValue === 'other') {
    cityBlockEl.style.display = '';
    collegeEl.style.display = '';
    collegeIdEl.value = '';

    // Make fields required once again
    cityEl.required = true;
    collegeEl.required = true;

    return;
  } else {
    cityBlockEl.style.display = 'none';
    collegeEl.style.display = 'none';
  }
  var collegeId = localChapterValue;

  // Remove required of redundant fields
  cityEl.required = false;
  collegeEl.required = false;

  collegeIdEl.value = collegeId;

  // Disable the null entry
  localChapterNullEntry = element('local_chapter_college_');
  localChapterNullEntry.disabled = true;
}

function MakeReadOnlyIfRequired() {
  //function to make the entire form read only and disable inputs
  // Checks a hidden input make_reg_form_read_only which is populated using jinja2.

  makeReadOnly = element('make_reg_form_read_only').value;
  if (makeReadOnly) {
    // Remove agree terms, honor code, and submit button
    $('#termsLi, #honor_codeLi, #regFormSubmitLi').css('display', 'none');
    // Make everything else disabled
    $('#registrationFields :input, select').prop('disabled', true);
    // Beautify the form
    $('input:disabled, select:disabled')
    .css('color', 'black')
    .css('background-color', 'white')
    .css('border', '1px solid')
    .css('border-color', 'grey');

    // Make headings smaller
    $('#registrationFields h2').css('display', 'none');
  }
}

function initRegisterForm() {
  fillCountriesOptions();
  fillIndianStateOptions();
  fillLocalChapterCollegeOptions();
  fillGraduationYearOptions();
  prefillSelect('old_country_of_residence', 'country_of_residence', 'country_');
  countryChanged();
  old_value =  element('old_country_of_residence').value;
  if ('IN' == old_value) {
    prefillSelect('old_state_of_residence', 'state_of_residence', 'state_');
  }
  prefillSelect('old_graduation_year', 'graduationyear', 'year_');
  prefillSelect('old_age_group', 'age_group', 'age_group_');
  // yearOfGraduationChanged();
  prefillSelect('old_profession', 'profession', 'profession_');
  professionChanged();
  prefillSelect('old_local_chapter', 'local_chapter', 'local_chapter_');
  hideShowLocalChapter(null, null);
  localChapterCollegeChanged();
  IndianStateOnChanged();
  MakeReadOnlyIfRequired();
}

function validateForm() {
  // TODO(rthakker) Remove these validations after confirming that the 'required'
  // field works on old browsers.
  var name = element('form01').value;
  if (name == null || name.trim() == '') {
     alert('Please fill your name');
     return false;
  }
  var mobile_number = element('mobile_number').value;
  if (mobile_number == null || !isValidMobileNumber()) {
     alert('Please fill a valid mobile number');
     return false;
  }

  var country_of_residence = getSelectValue(
      element('country_of_residence'));
  if (country_of_residence == null || country_of_residence == '') {
     alert('Please select your country of residence.');
     return false;
  }

  if ('IN' == country_of_residence) {
    var state_of_residence = getSelectValue(
      element('state_of_residence'));
    if (state_of_residence == null || state_of_residence == '') {
      alert('Please select your state of residence.');
      return false;
    }
  }

  var city_of_residence_el = element('city_of_residence');
  var city_of_residence = city_of_residence_el.value;
  if (city_of_residence_el.required) {
    if (city_of_residence == null || city_of_residence.trim() == '') {
       alert('Please fill your city of residence.');
       return false;
    }
  }

  var college_el = element('college');
  var college = element('college').value;
  if (college_el.required) {
    if (college == null || college.trim() == '') {
       alert('Please fill name of your college.');
       return false;
    }
  }

  var graduationyear = getSelectValue(
      element('graduationyear'));
  if (graduationyear == null || graduationyear == '') {
     alert('Please select your year of graduation.');
     return false;
  }

  var age_group = getSelectValue(
      element('age_group'));
  if (age_group == null || age_group == '') {
     alert('Please select your age group.');
     return false;
  }

  var employer_block = element('employerLi');
  if (employer_block.style.display == '') {
      var employer = element('employer').value;
      if (employer == null || employer.trim() == '') {
          alert('Please fill your employer.');
          return false;
      }
  }

  var termsInput = element('terms');
  if (null == termsInput || !termsInput.checked) {
     alert('Please accept Terms of Service');
     return false;
  }

  var honorInput = element('honor_code');
  if (null == honorInput || !honorInput.checked) {
     alert('Please accept Honor Code');
     return false;
  }
  return true;
}

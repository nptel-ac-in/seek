<link rel="import" href="/static/polymer-1.2.0/polymer/polymer.html">
<link rel="import" href="/modules/explorer/_static/components/course-cards/course-cards.html">

<dom-module id="course-card-grouper">
  <style>
    h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-weight: normal;
      font-size: 18px;
      color: rgba(0, 0, 0, 0.54);
    }

    course-cards {
      margin-bottom: 32px;
    }
  </style>
  <template>
    <template is="dom-if" if="[[noCourses]]">
      <h2>No courses</h2>
    </template>

  <div id="open">
    <template is="dom-if" if="[[openCourses.length]]">
    <course-cards courses="[[openCourses]]"></course-cards>
    </template>
  </div>

  <div id="library">
    <template is="dom-if" if="[[otherCourses.length]]">
        <course-cards courses="[[otherCourses]]"></course-cards>
      </template>
  </div>
  </template>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
  <script>
    Polymer({
      is: 'course-card-grouper',
      properties: {
        courses: {
          type: Array,
        }
      },
      observers: ['coursesObserver(courses.*)'],
      coursesObserver: function(observed) {
        var courses = observed.base;
        var open = [];
        var other = [];
        courses.forEach(function(course) {
          if (course.node.openForRegistration) {
            open.push(course);
          } else {
            other.push(course);
          }
        });
        this.openCourses = open;
        this.otherCourses = other;
        this.noCourses = (other.length == 0 && open.length == 0);
      },
      isntOne: function(value) {
        return value != 1;
      }
    })

    function loadMoreOpenCourses() {
      console.log("More Open Courses loaded");
      // $("body").append("<div>");
      $("#open paper-card:hidden:lt(20)").show();
    }
    function loadMoreOtherCourses() {
      console.log("More Other Courses loaded");
      // $("body").append("<div>");
      $("#library paper-card:hidden:lt(20)").show();
    }

    function bindScroll(e) {
      // Check if open courses needs to be displayed
      var loadingCourses = false;

      var openCoursesRect = $("#open")[0].getBoundingClientRect()
      if (openCoursesRect.y + openCoursesRect.height < window.innerHeight) {
        $(window).unbind('scroll');
        loadMoreOpenCourses();
        loadingCourses = true;
      }

      var otherCoursesRect = $("#library")[0].getBoundingClientRect()
      if (otherCoursesRect.y + otherCoursesRect.height < window.innerHeight) {
        if (!loadingCourses) {
          $(window).unbind('scroll');
        }
        loadMoreOtherCourses();
        loadingCourses = true;
      }
      if (loadingCourses) {
        setTimeout(function() {
          $(window).bind('scroll', bindScroll);
        }, 1000)
      }

      // if ($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
      //   $(window).unbind('scroll');
      //   loadMore();
      // }
    }

    $(window).scroll(bindScroll);
  </script>
</dom-module>
